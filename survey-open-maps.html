<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Survey / PseudoSurvey → Push GPS to PC (Continuous, No Maps)</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.5; margin: 0; padding: 24px; }
    main { max-width: 900px; margin: 0 auto; }
    h1 { margin-bottom: .25rem; }
    nav { margin: 12px 0 24px; display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .muted { opacity: .8; font-size: .95em; }
    .hidden { display: none !important; }
    .error { color: #b00020; }

    fieldset { border: 1px solid #999; border-radius: 12px; padding: 16px; margin: 16px 0; }
    legend { padding: 0 6px; }
    label { display: block; margin: 8px 0; }
    .inline { display: inline-flex; align-items: center; gap: 8px; margin-right: 12px; }

    button { font: inherit; padding: 10px 16px; border-radius: 10px; border: 1px solid currentColor; cursor: pointer; }
    .row { display: grid; gap: 8px; grid-template-columns: 1fr; }
    .stack { display: grid; gap: 10px; }

    .stepper { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .chip { border: 1px solid currentColor; padding: 2px 8px; border-radius: 999px; font-size: .9em; }
    .box { border: 1px dashed currentColor; border-radius: 12px; padding: 16px; }

    #coords { margin-top: 8px; }
    #tracking { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    #tracking .pill { border:1px solid currentColor; border-radius:999px; padding:4px 10px; }

    #debug { margin-top: 16px; padding: 10px 12px; border-radius: 10px; border: 1px dashed currentColor; }
  </style>
</head>
<body>
  <main>
    <h1>Survey → Push GPS to your PC (continuous)</h1>
    <p class="muted">Serve over <strong>HTTPS</strong> (or <code>localhost</code>). After submit, this page requests permission and <strong>continuously sends</strong> coordinates to your PC via ntfy until stopped or closed. It does <em>not</em> open Maps.</p>

    <div id="httpsWarn" class="error hidden">This page must be served over HTTPS (or localhost) for location to work.</div>

    <nav>
      <strong>Mode:</strong>
      <button type="button" id="modeSurveyBtn">Full Survey</button>
      <button type="button" id="modePseudoBtn">PseudoSurvey</button>
      <span class="muted">(or use <code>?mode=survey</code> / <code>?mode=pseudo</code>)</span>
    </nav>

    <!-- ===================== FULL SURVEY ===================== -->
    <section id="surveyMode" class="stack">
      <h2>Full Survey</h2>
      <p class="muted">On submit, we’ll ask for location permission and begin continuous tracking.</p>

      <form id="survey" novalidate>
        <fieldset>
          <legend>What are you reporting today?</legend>
          <label class="inline"><input type="radio" name="topic" value="meeting" required> Meeting point</label>
          <label class="inline"><input type="radio" name="topic" value="delivery"> Delivery location</label>
          <label class="inline"><input type="radio" name="topic" value="incident"> Incident/issue</label>
          <label class="inline"><input type="radio" name="topic" value="other"> Other</label>
          <div class="muted">Required</div>
        </fieldset>

        <fieldset>
          <legend>Options</legend>
          <label class="inline"><input type="checkbox" id="keepAwake" checked> Keep screen awake while tracking</label>
          <label class="inline"><input type="checkbox" id="highAccuracy" checked> High accuracy (GPS)</label>
        </fieldset>

        <fieldset>
          <legend>Consent</legend>
          <label class="inline">
            <input type="checkbox" name="consent" required>
            I agree to share this device’s location continuously until I stop tracking or close this page.
          </label>
          <div class="muted">Required</div>
        </fieldset>

        <button id="submitBtn" type="submit">Submit & Start Tracking</button>
        <div id="status" class="muted" aria-live="polite"></div>
        <p id="error" class="error hidden"></p>

        <div id="tracking" class="hidden">
          <span class="pill" id="tState">Tracking…</span>
          <span class="pill" id="tCount">Updates: 0</span>
          <span class="pill" id="tLast">Last: –</span>
          <span class="pill" id="tAcc">± – m</span>
          <button type="button" id="stopBtn">Stop</button>
        </div>

        <p id="coords" class="muted"></p>
        <div id="debug" class="muted hidden"></div>
      </form>
    </section>

    <!-- ===================== PSEUDOSURVEY ===================== -->
    <section id="pseudoMode" class="stack hidden">
      <h2>PseudoSurvey (quick)</h2>
      <p class="muted">Confirm → start continuous tracking (no maps will open).</p>

      <div class="box">
        <div class="stepper muted">
          <span class="chip" id="psStep">Step 1/3</span>
          <span id="psStatus">Ready</span>
        </div>

        <div id="psPane1" class="stack">
          <p><strong>Confirm:</strong> You consent to continuously share this device’s location until you stop or close this page.</p>
          <div>
            <label class="inline"><input type="checkbox" id="psKeepAwake" checked> Keep screen awake</label>
            <label class="inline"><input type="checkbox" id="psHighAcc" checked> High accuracy</label>
          </div>
          <button type="button" id="psStart">I Agree — Start</button>
        </div>

        <div id="psPane2" class="stack hidden">
          <p>Preflight checks… collecting non-identifying diagnostics.</p>
          <button type="button" id="psGo">Begin tracking</button>
          <p class="muted">You will see a location permission prompt.</p>
        </div>

        <div id="psPane3" class="stack hidden">
          <div id="psTrackBar" class="stepper">
            <span class="chip" id="psState">Tracking…</span>
            <span class="chip" id="psCount">Updates: 0</span>
            <span class="chip" id="psLast">Last: –</span>
            <span class="chip" id="psAcc">± – m</span>
            <button type="button" id="psStop">Stop</button>
          </div>
          <p id="psError" class="error hidden"></p>
        </div>
      </div>
    </section>

    <p class="muted">Tip: Keep the page visible and screen awake. Mobile browsers may pause background tabs. Wake Lock helps but is not guaranteed on all devices.</p>
  </main>

  <script>
  'use strict';

  // =================== CONFIG ===================
  const NTFY_TOPIC = "jk-9f1b7c73c1e24e3e9d3d-loc"; // e.g., "jk-9f1b7c73c1e24e3e9d3d-loc"
  const SUBMIT_ENDPOINT = null; // optional logging endpoint
  const MIN_INTERVAL_MS = 10000; // send at least every 10s on movement
  const MIN_MOVE_M = 5;          // or when moved > 5 m
  const HEARTBEAT_MS = 15000;    // also resend last known fix every 15s even if stationary

  // =================== UTIL ===================
  const $ = (sel, root = document) => root.querySelector(sel);
  const to6 = n => Math.round(n * 1e6) / 1e6;
  const nowISO = () => new Date().toISOString();

  function setDebug(msg){ const d=$('#debug'); if(!d) return; d.textContent = msg; d.classList.remove('hidden'); }

  // Global error surfacing
  window.addEventListener('error', e => setDebug('JS error: ' + e.message));
  window.addEventListener('unhandledrejection', e => setDebug('Promise error: ' + (e.reason && e.reason.message || e.reason)));

  // HTTPS check
  (function(){
    const warn = $('#httpsWarn');
    const ok = location.protocol === 'https:' || location.hostname === 'localhost';
    if (!ok) warn.classList.remove('hidden');
  })();

  async function logJSON(payload) {
    if (!SUBMIT_ENDPOINT) return;
    try {
      await fetch(SUBMIT_ENDPOINT, { method:'POST', headers:{'Content-Type':'text/plain;charset=utf-8'}, body: JSON.stringify(payload), keepalive:true });
    } catch (e) { setDebug('Logging failed: ' + e); }
  }

  async function pushToPC(lat, lng, acc) {
    if (!NTFY_TOPIC) return;
    try {
      await fetch(`https://ntfy.sh/${encodeURIComponent(NTFY_TOPIC)}`, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // simple request (no preflight)
        body: JSON.stringify({ type:'location', lat: to6(lat), lng: to6(lng), acc: acc ?? null, ts: Date.now() }),
        keepalive: true
      });
    } catch (e) { setDebug('Push failed: ' + e); }
  }

  async function showAndCopyCoords(lat, lng, acc) {
    const text = `${to6(lat)},${to6(lng)}  (±${Math.round(acc||0)} m)`;
    const el = $('#coords');
    if (el) el.textContent = `Coordinates: ${text} (copied)`;
    try { await navigator.clipboard.writeText(text); } catch {}
  }

  function geolocateOnce(opts) {
    if (!('geolocation' in navigator)) return Promise.reject(Object.assign(new Error('Geolocation not supported'), { code: -1 }));
    return new Promise((resolve, reject) => {
      navigator.geolocation.getCurrentPosition(resolve, reject, Object.assign({ enableHighAccuracy: true, maximumAge: 0, timeout: 15000 }, opts||{}));
    });
  }

  // Wake Lock
  let wakeLock = null;
  async function requestWakeLock() { try { if ('wakeLock' in navigator) { wakeLock = await navigator.wakeLock.request('screen'); document.addEventListener('visibilitychange', async () => { if (document.visibilityState === 'visible' && wakeLock?.released) { try { wakeLock = await navigator.wakeLock.request('screen'); } catch {} } }); } } catch {}
  }
  async function releaseWakeLock() { try { await wakeLock?.release(); } catch {} finally { wakeLock = null; } }

  // Continuous tracking
  let watchId = null, heartbeatId = null; let lastFix = null; let lastSent = { lat:null, lng:null, t:0 }; let updateCount = 0;

  function metersBetween(lat1, lon1, lat2, lon2) {
    if (lat2 == null || lon2 == null) return Infinity;
    const R = 6371000; const toRad = x => x * Math.PI / 180;
    const dLat = toRad(lat2 - lat1), dLon = toRad(lon2 - lon1);
    const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
    return 2 * R * Math.asin(Math.sqrt(a));
  }

  function startTracking({ highAccuracy = true, keepAwake = true } = {}) {
    if (!('geolocation' in navigator)) throw new Error('Geolocation not supported');
    if (watchId !== null) return; // already running

    updateCount = 0; lastFix = null; lastSent = { lat:null, lng:null, t:0 };
    if (keepAwake) requestWakeLock();

    const opts = { enableHighAccuracy: !!highAccuracy, maximumAge: 0, timeout: 20000 };

    watchId = navigator.geolocation.watchPosition(pos => {
      const { latitude:lat, longitude:lng, accuracy:acc } = pos.coords;
      const t = Date.now();
      lastFix = { lat, lng, acc, t };
      const moved = metersBetween(lat, lng, lastSent.lat, lastSent.lng) > MIN_MOVE_M;
      const elapsed = t - (lastSent.t || 0);
      if (moved || elapsed >= MIN_INTERVAL_MS) {
        lastSent = { lat, lng, t };
        updateCount++;
        pushToPC(lat, lng, acc);
        showAndCopyCoords(lat, lng, acc);
        updateTrackUI({ lat, lng, acc, t });
        logJSON({ stage: 'tracking_update', latitude: lat, longitude: lng, accuracy: acc, count: updateCount, at: nowISO() });
      }
    }, err => { updateTrackUI({ error: err }); }, opts);

    heartbeatId && clearInterval(heartbeatId);
    heartbeatId = setInterval(() => {
      if (!lastFix) return;
      const t = Date.now();
      if (t - (lastSent.t || 0) >= HEARTBEAT_MS) {
        const { lat, lng, acc } = lastFix;
        lastSent = { lat, lng, t };
        updateCount++;
        pushToPC(lat, lng, acc);
        updateTrackUI({ lat, lng, acc, t });
        logJSON({ stage: 'heartbeat_update', latitude: lat, longitude: lng, accuracy: acc, count: updateCount, at: nowISO() });
      }
    }, HEARTBEAT_MS);

    updateTrackUI({ started: true });
  }

  function stopTracking() {
    if (watchId !== null) { navigator.geolocation.clearWatch(watchId); watchId = null; }
    if (heartbeatId) { clearInterval(heartbeatId); heartbeatId = null; }
    releaseWakeLock();
    updateTrackUI({ stopped: true });
  }

  function updateTrackUI({ lat, lng, acc, t, started, stopped, error } = {}) {
    const tWrap = $('#tracking');
    if (tWrap) {
      if (started) tWrap.classList.remove('hidden');
      if (stopped) tWrap.classList.add('hidden');
      if (lat != null && lng != null) {
        $('#tCount').textContent = `Updates: ${updateCount}`;
        $('#tLast').textContent = `Last: ${new Date(t || Date.now()).toLocaleTimeString()}`;
        $('#tAcc').textContent = `± ${acc ? Math.round(acc) : '–'} m`;
        $('#tState').textContent = 'Tracking…';
      }
      if (error) {
        const code = error.code;
        const msg = code === 1 ? 'Permission denied' : code === 3 ? 'Timed out' : 'Position unavailable';
        $('#tState').textContent = `Error: ${msg}`;
        setDebug('Geolocation error: ' + msg);
      }
    }
    const psBar = $('#psTrackBar');
    if (psBar) {
      if (started) psBar.classList.remove('hidden');
      if (stopped) psBar.classList.add('hidden');
      if (lat != null && lng != null) {
        $('#psCount').textContent = `Updates: ${updateCount}`;
        $('#psLast').textContent = `Last: ${new Date(t || Date.now()).toLocaleTimeString()}`;
        $('#psAcc').textContent = `± ${acc ? Math.round(acc) : '–'} m`;
        $('#psState').textContent = 'Tracking…';
      }
      if (error) {
        const code = error.code;
        const msg = code === 1 ? 'Permission denied' : code === 3 ? 'Timed out' : 'Position unavailable';
        $('#psState').textContent = `Error: ${msg}`;
        setDebug('Geolocation error: ' + msg);
      }
    }
  }

  // =================== SURVEY FLOW ===================
  (function initSurveyFlow(){
    const form = $('#survey');
    const submitBtn = $('#submitBtn');
    const stopBtn = $('#stopBtn');
    const status = $('#status');
    const errEl = $('#error');

    function errorOut(msg) { errEl.textContent = msg || 'Failed to get location.'; errEl.classList.remove('hidden'); }
    function clearError(){ errEl.classList.add('hidden'); errEl.textContent=''; }

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      clearError();
      // Safer validity check across browsers
      if (typeof form.checkValidity === 'function' && !form.checkValidity()) {
        if (typeof form.reportValidity === 'function') form.reportValidity();
        return;
      }

      const keepAwake = $('#keepAwake')?.checked;
      const highAcc   = $('#highAccuracy')?.checked;

      submitBtn.disabled = true;
      status.textContent = 'Requesting location permission…';

      try {
        await geolocateOnce({ enableHighAccuracy: !!highAcc });
        status.textContent = 'Starting continuous tracking…';
        startTracking({ highAccuracy: !!highAcc, keepAwake: !!keepAwake });
      } catch (err) {
        let msg = 'Failed to get location.';
        switch (err && err.code) {
          case 1: msg = 'Permission denied. Allow location for this site in your browser settings, then retry.'; break;
          case 2: msg = 'Position unavailable. Move to an open area or check GPS/network and retry.'; break;
          case 3: msg = 'Timed out. Please try again.'; break;
        }
        errorOut(msg);
        setDebug('Prime error: ' + (err && err.message || msg));
        submitBtn.disabled = false;
        return;
      }

      status.textContent = 'Tracking… keep this page open.';
    });

    stopBtn?.addEventListener('click', () => {
      stopTracking();
      status.textContent = 'Stopped.';
      submitBtn.disabled = false;
    });
  })();

  // =================== PSEUDOSURVEY FLOW ===================
  (function initPseudoFlow(){
    const step = $('#psStep');
    const status = $('#psStatus');
    const pane1 = $('#psPane1');
    const pane2 = $('#psPane2');
    const pane3 = $('#psPane3');

    function setStep(n, text){ step.textContent = `Step ${n}/3`; if (text) status.textContent = text; }
    function showPane(p){ [pane1,pane2,pane3].forEach(x=>x.classList.add('hidden')); p.classList.remove('hidden'); }

    $('#psStart')?.addEventListener('click', async () => {
      setStep(2, 'Preflight');
      showPane(pane2);
      const diag = { ts: nowISO(), tz: Intl.DateTimeFormat().resolvedOptions().timeZone };
      logJSON({ mode: 'pseudo', stage: 'diagnostics', diagnostics: diag });
    });

    $('#psGo')?.addEventListener('click', async () => {
      showPane(pane3);
      const keepAwake = $('#psKeepAwake')?.checked;
      const highAcc   = $('#psHighAcc')?.checked;
      try {
        await geolocateOnce({ enableHighAccuracy: !!highAcc });
        startTracking({ highAccuracy: !!highAcc, keepAwake: !!keepAwake });
      } catch (e) {
        const err = $('#psError');
        const msg = (e && e.code === 1) ? 'Permission denied. Enable location and retry.' : (e && e.code === 3) ? 'Timed out. Try again.' : 'Position unavailable.';
        err.textContent = msg;
        err.classList.remove('hidden');
        setDebug('Prime error (pseudo): ' + (e && e.message || msg));
      }
    });

    $('#psStop')?.addEventListener('click', () => { stopTracking(); });
  })();

  // =================== MODE SWITCHING ===================
  (function initMode(){
    const surveyMode = $('#surveyMode');
    const pseudoMode = $('#pseudoMode');
    const btnSurvey = $('#modeSurveyBtn');
    const btnPseudo = $('#modePseudoBtn');

    function applyMode(mode){ if (mode === 'pseudo') { surveyMode.classList.add('hidden'); pseudoMode.classList.remove('hidden'); } else { surveyMode.classList.remove('hidden'); pseudoMode.classList.add('hidden'); } }
    function getModeFromURL(){ const usp = new URLSearchParams(location.search); return (usp.get('mode') === 'pseudo') ? 'pseudo' : 'survey'; }
    function updateQuery(key, val){ const url = new URL(location.href); url.searchParams.set(key, val); return url.toString(); }

    btnSurvey?.addEventListener('click', () => { applyMode('survey'); history.replaceState({}, '', updateQuery('mode','survey')); });
    btnPseudo?.addEventListener('click', () => { applyMode('pseudo'); history.replaceState({}, '', updateQuery('mode','pseudo')); });
    applyMode(getModeFromURL());
  })();

  </script>
</body>
</html>
